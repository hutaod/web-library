# Reactç³»åˆ—

å­¦å¥½ä¸€é—¨æŠ€æœ¯ï¼Œéœ€è¦ç»å†å¤§æ¦‚ä¸‰ä¸ªè¿‡ç¨‹ï¼šè¯»æ–‡æ¡£ï¼Œè¿ç”¨ï¼Œçœ‹æºç 

æœ¬æ–‡æ¡£ä¸»è¦ç”¨äºè®°å½• React çš„ä¸€äº›è¿ç”¨ï¼Œå’Œé€šè¿‡é˜…è¯» React ç›¸å…³æŠ€æœ¯æ ˆçš„æºç ï¼Œæ¥æ›´æ·±å±‚æ¬¡çš„å­¦ä¹ ï¼Œè¯»æºç ä¸æ˜¯ä¸ºäº†é€ ä¸€ä¸ªåŒæ ·çš„è½®å­ï¼Œè€Œæ˜¯ä»åˆ«äººçš„ä»£ç ä¸­å­¦ä¹ åˆ°æ›´å¤šçš„çŸ¥è¯†ï¼Œå†™å‡ºæ›´å¥½çš„è¿ç”¨æ–¹æ³•ã€‚

ç›®å½•ï¼š
- Reactä½¿ç”¨æ€»ç»“
- æºç æ¢ç´¢

## Reactä½¿ç”¨æ€»ç»“

### React ä¸­æ³¨æ„äº‹é¡¹

- react å¿…é¡»åœ¨ react-dom ä¹‹å‰å¼•å…¥
- ä¸èƒ½ä»¥ body ä½œä¸ºå®¹å™¨
- å¼•å…¥babelå¹¶ç»™scriptè®¾ç½®typeå¯ä»¥æ”¯æŒjsxè¯­æ³•
- react æ ¹å…ƒç´ åªèƒ½æœ‰ä¸€ä¸ª
- æ’å€¼è¡¨è¾¾å¼
  - æ­£å¸¸æ˜¾ç¤ºçš„ç±»å‹: String Number
  - ä¸æ˜¾ç¤ºä¹Ÿä¸ä¼šæŠ¥é”™çš„ç±»å‹ï¼šBoolean null undefined
  - æ’å€¼è¡¨è¾¾å¼ä¸­ä¸èƒ½ç›´æ¥è¾“å…¥çš„ç±»å‹ï¼šå¯¹è±¡ï¼ˆé™¤å»æ•°ç»„ï¼‰æ•°ç»„ä¼šè½¬æ¢ä¸ºå­—ç¬¦ä¸²ï¼Œå¹¶ç”¨ç©ºå­—ç¬¦ä¸²æ‹¼æ¥
- JSXå±æ€§
  - jsxæ ‡ç­¾ä¹Ÿæ˜¯æ”¯æŒå±æ€§è®¾ç½®çš„
  - jsxæ ‡ç­¾ä¹Ÿæ˜¯æ”¯æŒå±æ€§è®¾ç½®çš„
  - åŸºæœ¬ä¸Šå’Œhtml/xmlç±»ä¼¼
  - å±æ€§ä¹Ÿæ”¯æŒæ’å€¼è¡¨è¾¾å¼
    æ³¨æ„ï¼š1. classï¼š ä½¿ç”¨classNameå±æ€§ä»£æ›¿ï¼›2. styleï¼š å€¼å¿…é¡»ä½¿ç”¨å¯¹è±¡
- Reactæ²¡æœ‰æ¨¡æ¿è¯­æ³•ï¼Œ æ’å€¼è¡¨è¾¾å¼ä¸­åªæ”¯æŒè¡¨è¾¾å¼ï¼Œä¸æ”¯æŒè¯­å¥ï¼šfor/ifï¼Œé€šè¿‡æ•°ç»„ç”Ÿæˆçš„ç»“æ„ï¼Œæ¯ä¸ªå…ƒç´ éƒ½å¿…é¡»åŒ…å«ä¸€ä¸ªkeyå±æ€§ï¼Œä¸”æ¯ä¸ªkeyå±æ€§å€¼æ˜¯å”¯ä¸€çš„
- å‡½æ•°ä½¿ç”¨ï¼šç»„ä»¶-æ‹¥æœ‰ç‹¬ç«‹åŠŸèƒ½çš„ä¸€ä¸ªæ¨¡å—ï¼Œå‡½æ•°æ ‡ç­¾åŒ–-é€šè¿‡æ ‡ç­¾å±æ€§ä¼ å…¥
- ä¸€ä¸ªå‡½æ•°æˆ–è€…ç±»ä½œä¸ºä¸€ä¸ªç»„ä»¶å»ä½¿ç”¨çš„è¯ï¼Œ é‚£ä¹ˆåç§°å¿…é¡»é¦–å­—æ¯å¤§å†™
- å¦‚æœä½¿ç”¨ç±»å®ç°ç»„ä»¶ï¼Œéœ€è¦ç»§æ‰¿ä¸€ä¸ªçˆ¶ç±»ï¼šReact.Componentï¼Œpropsï¼šä¼ å…¥çš„å‚æ•°å¿…é¡»æ˜¯å¯¹è±¡çš„ä¸‹ä¸€ä¸ªå±æ€§propsæ¥æ¥æ”¶

### ç»„ä»¶è·¨å±‚çº§é€šä¿¡ - Context
åœ¨Contextæ¨¡å¼ä¸‹æœ‰ä¸¤ä¸ªè§’è‰²ï¼š
- Providerï¼šå¤–å±‚æä¾›æ•°æ®çš„ç»„ä»¶
- Consumerï¼šå†…å±‚è·å–æ•°æ®çš„ç»„ä»¶
  
å®ç°Contextï¼š
```javascript
// 1. åˆ›å»ºä¸Šä¸‹æ–‡
const Context = React.createContext()

// 2. è·å–Providerå’ŒConsumer
const Provider = Context.Provider
const Consumer = Context.Consumer

```

å½“Contextä½¿ç”¨æ—¶ï¼Œåº”å½“é¿å…ç›´æ¥ä½¿ç”¨Providerç»„ä»¶ï¼Œ
å¦åˆ™æ¯æ¬¡æ›´æ”¹Providerçš„valueå†…å®¹éƒ½ä¼šé‡æ–°æ¸²æŸ“å®ƒçš„æ‰€æœ‰å­ç»„ä»¶ï¼Œ
åº”å½“æŠ½ç¦»Providerï¼Œå•ç‹¬å°è£…ä¸€ä¸ªå±‚å¤åˆç»„ä»¶

ä¸‹é¢æ˜¯æˆ‘æ€»ç»“å‡ºæ¥çš„Contextä¸€ç§ä½¿ç”¨æ–¹å¼ï¼š
```javascript

// åˆ›å»ºContextProviderç»„ä»¶ç”¨äºå­˜å–Provideræ•°æ®
class ContextProvider extends Component {
  state = {
    counter: 0
  }
  add = (num = 1) => {
    this.setState({
      counter: this.state.counter + num
    })
  }
  render() {
    return (
      <Provider
        value={{
          ...this.state,
          add: this.add
        }}
      >
        {this.props.children}
      </Provider>
    )
  }
}

// å°è£…ä¸€ä¸ªé«˜é˜¶ç»„ä»¶withConsumerï¼Œå®ƒæ ¹æ®é…ç½®è¿”å›ä¸€ä¸ªé«˜é˜¶ç»„ä»¶
// ç”¨Consumeræ–¹å¼ä½¿ç”¨æ—¶æ›´æ–¹ä¾¿
function withConsumer(Consumer) {
  return Comp => props => {
    return <Consumer>{value => <Comp {...value} />}</Consumer>
  }
}

class App extends Component {
  render() {
    return (
      <ContextProvider>
        <MiddleComp />
      </ContextProvider>
    )
  }
}

// å½“Providerçš„valueæ”¾åœ¨Appçš„stateè¿›è¡Œç®¡ç†çš„æ—¶å€™ï¼Œ
// æ¯æ¬¡æ”¹å˜valueï¼Œéƒ½ä¼šé‡æ–°æ¸²æŸ“MiddleCompç»„ä»¶
// ç”¨ContextProvideræ›¿æ¢åå°±ä¸ä¼šé‡æ–°æ¸²æŸ“MiddleCompç»„ä»¶
const MiddleComp = () => {
  console.log('MiddleComp')
  return (
    <div>
      <Child />
      <Child />
      <Child />
    </div>
  )
}

// å­ç»„ä»¶
const ChildComp = (props) => {
  return (
    <div
      onClick={() => {
        props.add()
      }}
    >
      {props.counter}
    </div>
  )
}

// ç”¨withConsumeré«˜é˜¶ç»„ä»¶åŒ…è£…å­ç»„ä»¶
const Child = withConsumer(Consumer)(ChildComp)
```

è·å–ä¸Šä¸‹æ–‡å†…å®¹æ—¶ä¹Ÿå¯ä»¥ç”¨ä¸‹é¢ä¸¤ç§æ–¹å¼:
1. classç»„ä»¶æ—¶
```javascript
class Child2 extends Component {
  static contextType = Context
  render() {
    return (
      <div
        onClick={() => {
          this.context.add()
        }}
      >
        {this.context.counter}
      </div>
    )
  }
}
```
2. å‡½æ•°ç»„ä»¶æ—¶
```javascript
const Child3 = (props) => {
  const context = useContext(Context)
  return (
    <div
      onClick={() => {
        context.add()
      }}
    >
      {context.counter}
    </div>
  )
}
```

é‡å†™MiddleCompï¼Œä½ ä¼šå‘ç°æ•ˆæœæ˜¯ä¸€æ ·çš„
```javascript
const MiddleComp = () => {
  console.log('MiddleComp')
  return (
    <div>
      <Child />
      <Child2 />
      <Child3 />
    </div>
  )
}
```

å‚è€ƒé“¾æ¥ï¼š
[é¿å…React Contextå¯¼è‡´çš„é‡å¤æ¸²æŸ“](https://zhuanlan.zhihu.com/p/50336226)

### é«˜é˜¶ç»„ä»¶
é«˜é˜¶ç»„ä»¶ï¼ˆHOCï¼‰æ˜¯ `React` ä¸­ç”¨äºå¤ç”¨ç»„ä»¶é€»è¾‘çš„ä¸€ç§é«˜çº§æŠ€å·§ï¼Œé«˜é˜¶ç»„ä»¶æ˜¯ä¸€ä¸ªå·¥å‚å‡½æ•°ï¼Œå®ƒæ¥æ”¶ä¸€ä¸ªå‚æ•°å¹¶è¿”å›å¦å¤–ä¸€ä¸ªç»„ä»¶ã€‚

`HOC`çš„ä½¿ç”¨ï¼š
1. æ‰©å±•å•ä¸€ç»„ä»¶ï¼Œè®©å®ƒå˜å¾—æ›´å¼ºå¤§ï¼Œä¸‹é¢å°±æ˜¯ä¸€ç§é«˜é˜¶ç»„ä»¶ç®€å•ä½¿ç”¨ï¼š
```javascript

const models = {
  a: {
    name: 'æ°´æœåº—',
    productList: ['é¦™è•‰', 'ğŸ', 'æ¢¨']
  },
  b: {
    name: 'è¶…å¸‚',
    productList: ['åœ°ç“œ', 'ğŸ‰', 'æ´‹èŠ‹']
  }
}

const FruitShop = props => {
  return (
    <div>
      <h3>{props.name}</h3>
      <ul>
        {props.productList.map(a => (
          <li key={a}>{a}</li>
        ))}
      </ul>
    </div>
  )
}

// å®šä¹‰é«˜é˜¶ç»„ä»¶
const withCont = Comp => props => {
  const data = models[props.id]
  return <Comp {...props} {...data} />
}

// åŒ…è£…
const ShopWithCont = withCont(FruitShop)

function HocTest() {
  return (
    <div>
      {['a', 'b'].map(item => (
        <ShopWithCont id={item} key={item} />
      ))}
    </div>
  )
}
```

1. è‡ªå®šä¹‰å‚æ•°ï¼Œè¿”å›ä¸€ä¸ªæ–°çš„é«˜é˜¶ç»„ä»¶ï¼š
```javascript

// é‡å†™withCont
const withCont = mapModelToProps => {
  const data = mapModelToProps(models)
  return Comp => props => {
    return <Comp {...props} {...data} />
  }
}

// ä½¿ç”¨, è¿™æ ·ç»„ä»¶å°±å¯ä»¥åœ¨ä½¿ç”¨çš„æ—¶å€™è‡ªå®šä¹‰éœ€è¦çš„æ•°æ®
const ShopWithCont = withCont((models) => {
  return models['a']
})(FruitShop)

function HocTest() {
  return (
    <div>
      <ShopWithCont />
    </div>
  )
}
```

3. é«˜é˜¶ç»„ä»¶åµŒå¥—ä½¿ç”¨ï¼š
```javascript
// æ·»åŠ ä¸€ä¸ªwithLogé«˜é˜¶ç»„ä»¶ï¼Œèƒ½å¤Ÿåœ¨ç»„ä»¶æŒ‚è½½æ—¶è¾“å‡ºæ—¥å¿—
const withLog = Comp => {
  return class extends Component {
    componentDidMount() {
      console.log('didMount', this.props)
    }
    render() {
      return <Comp {...this.props} />
    }
  }
}

// åµŒå¥—ä½¿ç”¨é«˜é˜¶ç»„ä»¶
const ShopWithCont = withLog(withCont((models) => {
  return models['a']
})(FruitShop))

```

4. ä¸ºäº†æ›´å¥½çš„å®ç°åµŒå¥—ä½¿ç”¨å¤šä¸ªé«˜é˜¶ç»„ä»¶ï¼Œå®ç°ä¸€ä¸ªcomposeæ–¹æ³•ï¼Œæ–¹æ³•æ‘˜æŠ„è‡ª[redux](https://github.com/reduxjs/redux/blob/master/src/compose.js) ç»„ä»¶åº“ï¼Œè‡ªå·±çš„ç†è§£å†™åœ¨äº†æ³¨é‡Šä¸Š

```javascript
// å®ç°compose
function compose(...funcs) {
  // æ²¡æœ‰å‚æ•°çš„è¯ç›´æ¥è¿”å›ä¸€ä¸ªå‡½æ•°ç»„ä»¶
  // compose()(a) -> a
  // å…ˆè¿”å›ä¸€ä¸ªè¿”å›è‡ªèº«å‚æ•°çš„å‡½æ•° -> å‡½æ•°æ‰§è¡Œ,è¿”å›a
  if (funcs.length === 0) {
    return arg => arg
  }

  // åªæœ‰ä¸€ä¸ªå‡½æ•°å‚æ•°æ—¶è¿”å›è¯¥å‡½æ•°å‚æ•°
  // compose(withA)(a) -> withA(a)
  // å…ˆè¿”å›ä¸€ä¸ªwithAå‡½æ•° -> å‡½æ•°æ‰§è¡Œ,å¹¶ä¸”å‚æ•°ä¸ºa
  if (funcs.length === 1) {
    return funcs[0]
  }

  // ç”¨reduceéå†funcsï¼Œå¹¶ä¸”å½¢æˆæœ€ç»ˆéœ€è¦æ‰§è¡Œçš„å‡½æ•°
  // compose(withA, withB, withC, withD)(a) 
  // -> withA(withB(withC(withD(a))))
  return funcs.reduce((a, b) => {
    return (...args) => a(b(...args))
  })
  // å½“aï¼Œbå‚æ•°ä¸ºwithAï¼ŒwithBæ—¶ï¼Œ return (...args) -> withA(withB(...args))
  // å½“aï¼Œbå‚æ•°ä¸ºä¸Šä¸€è½®è¿”å›å‡½æ•°ï¼ŒwithCæ—¶ï¼Œ 
  // return (...args2) -> (...args) => withA(withB(...args))(withC(...args2)) 
  // æ‰§è¡Œç»“æœä¸ºï¼š 
  // (...args2) => withA(withB(withC))(withC(...args2))
  // ... æŒç»­æ‰§è¡Œ,æœ€ç»ˆç»“æœè¿”å›ä¸€ä¸ªå‡½æ•°ï¼Œå‡½æ•°çš„å‚æ•°æ”¾åœ¨funcsæœ€åä¸€ä¸ªå‡½æ•°ï¼š
  // (...argsN) => withA(withB(withC(...withN(...argsN))))
}
```
5. è£…é¥°å™¨å†™æ³•

é«˜é˜¶å‡½æ•°æœ¬èº«å°±æ˜¯å¯¹è£…é¥°å™¨æ¨¡å¼çš„åº”ç”¨ï¼Œå¯ä»¥åˆ©ç”¨ES7ä¸­å‡ºç°çš„ [è£…é¥°å™¨](https://es6.ruanyifeng.com/#docs/decorator) å†™æ³•æ¥æ›´ä¼˜é›…çš„ä¹¦å†™ä»£ç ã€‚å¦‚æœé¡¹ç›®ä¸æ”¯æŒè£…é¥°å™¨å†™æ³•ï¼Œéœ€è¦é¢å¤–é…ç½®ï¼Œå¦‚æœæ—¶tsé¡¹ç›®ï¼Œå°±å¯ä»¥ç›´æ¥æ”¯æŒè£…é¥°å™¨å†™æ³•ï¼Œä»£ç å¦‚ä¸‹ï¼š
```javascript
// æ‰§è¡Œé¡ºåºä»ä¸‹ç½‘ä¸Š, åŒcomposeæ–¹æ³• -> withA(withB(TestComp))
@withA
@withB
class TestComp extends Component {
  render() {
    return (
      ...
    )
  }
}
```
    æ³¨æ„ï¼šè£…é¥°å™¨åªèƒ½ç”¨åœ¨classä¸Š

### ç»„ä»¶ç»„åˆ Composition
ç»„ä»¶ç»„åˆæ–¹å¼ç»™äºˆä½ è¶³å¤Ÿçš„æ•æ·å»å®šä¹‰è‡ªå®šä¹‰ç»„ä»¶çš„å¤–è§‚å’Œè¡Œä¸ºï¼Œè¿™ç§æ–¹å¼æ›´æ˜ç¡®å’Œå®‰å…¨ã€‚å¦‚æœç»„ä»¶é—´æœ‰å…¬ç”¨çš„éUIé€»è¾‘ï¼Œå°†å®ƒä»¬æŠ½å–ä¸ºReactç»„ä»¶å¯¼å…¥ä½¿ç”¨ï¼Œè€Œä¸æ˜¯ç»§æ‰¿å®ƒ

ç»„ä»¶å¤åˆé€šå¸¸æœ‰ä»¥ä¸‹å‡ ç§å¸¸ç”¨çš„æ–¹å¼ï¼š
1. ç›´æ¥æ§åˆ¶props.childrenæ¥å®ç°
2. é€šè¿‡å±æ€§å®ç°

    æ³¨æ„ï¼šprops.children æ˜¯åˆæ³•çš„jsè¡¨è¾¾å¼ï¼Œjsxä¹Ÿä¼šè¢«ç¼–è¯‘ä¸ºjså¯¹è±¡ã€‚

ä¸»è¦è®°å½•ä¸€ä¸‹props.childrençš„å®ç°æ–¹å¼ï¼š
1. å¸¸ç”¨æ–¹å¼ï¼šç›´æ¥é€šè¿‡å±æ€§æ¥å®ç°å…·åæ’æ§½ï¼Œchildrenä¸ºé»˜è®¤æ’æ§½
```javascript
function Acticle(props) {
  const defaultFooter = 'åœ°å€: æ·±åœ³ ~~'
  return (
    <div>
      <h1>{props.title}</h1>
      <hr />
      <div>{props.children}</div>
      <hr />
      <footer>
        {props.footer ? props.footer(defaultFooter) : defaultFooter}
      </footer>
    </div>
  )
}

function CompositionBase() {
  return (
    <Acticle
      title={<div>æ–‡ç« æ ‡é¢˜</div>}
      footer={address => (
        <div style={{ color: '#f00' }}>
          æ–‡ç« footer
          <br />
          {address}
        </div>
      )}
    >
      <div>æ–‡ç« å†…å®¹</div>
      <div>æ–‡ç« å†…å®¹</div>
      <div>æ–‡ç« å†…å®¹</div>
    </Acticle>
  )
}

```
2. é€šè¿‡children ä¼ é€’å¯¹è±¡ï¼Œæ’å€¼éƒ½æ”¾åœ¨children
```javascript
function Modal(props) {
  return (
    <div>
      {props.children.def}
      <hr />
      <footer>{props.children.footer}</footer>
    </div>
  )
}

function CompositionChildrenObj() {
  return (
    <Modal>
      {{
        def: (
          <>
            <h1>é»˜è®¤æ ‡é¢˜</h1>
            <div>é»˜è®¤å†…å®¹</div>
          </>
        ),
        footer: (
          <button
            onClick={() => {
              alert('hello React!')
            }}
          >
            ç¡®å®š
          </button>
        )
      }}
    </Modal>
  )
}

```
3. é€šè¿‡children ä¼ é€’å‡½æ•°ï¼Œå¯ä»¥è·å–ç»„ä»¶å†…éƒ¨æ•°æ®ï¼Œæ¥è¿›è¡Œä¸‹ä¸€æ­¥æ“ä½œ
```javascript
function Dialog(props) {
  const messages = {
    foo: {
      title: 'foo',
      content: 'foo ~~'
    },
    bar: {
      title: 'bar',
      content: 'bar ~~'
    }
  }
  const { body, footer } = props.children(messages[props.type])
  return (
    <div>
      {body}
      <hr />
      <footer>{footer}</footer>
    </div>
  )
}

function CompositionChildrenFunc() {
  return (
    <Dialog type="bar">
      {({ title, content }) => ({
        body: (
          <>
            <h1>{title}</h1>
            <div>{content}</div>
          </>
        ),
        footer: (
          <button
            onClick={() => {
              alert(title)
            }}
          >
            ç¡®å®š
          </button>
        )
      })}
    </Dialog>
  )
}

```
4. å®ç°ç®€å•ç‰ˆRadioGroupå’ŒRadioç»„ä»¶

è€ƒè™‘ï¼šåœ¨RadioGroupä¸Šæ·»åŠ nameå±æ€§ï¼Œç»™å†…éƒ¨æ‰€æœ‰Radioéƒ½åŠ ä¸Šnameå±æ€§

æ³¨æ„ï¼šå¦‚æœProps.childrenæ˜¯jsxï¼Œæ­¤æ—¶å®ƒæ˜¯ä¸èƒ½ä¿®æ”¹çš„

```javascript
function RadioGroup(props) {
  const children = React.Children.map(props.children, child => {
    // è¦ä¿®æ”¹childå±æ€§å¿…é¡»å…ˆå…‹éš†å®ƒ
    return React.cloneElement(child, { name: props.name })
  })
  return children
}

// Radioä¼ å…¥value,nameå’Œchildrenï¼Œæ³¨æ„åŒºåˆ†
function Radio({ children, ...rest }) {
  return (
    <label>
      <input {...rest} type="radio" />
      {children}
    </label>
  )
}

function TestRadioGroup() {
  const data = [{ label: 'ğŸ', value: 1 }, { label: 'é¦™è•‰', value: 2 }]
  return (
    <RadioGroup name="hello">
      {data.map(item => (
        <Radio key={item.value} value={item.value}>
          {item.label}
        </Radio>
      ))}
    </RadioGroup>
  )
}
```

### Hook

`Hook`æ˜¯`React16.8`çš„æ–°å¢é¡¹ï¼Œå®ƒå¯ä»¥è®©ä½ åœ¨ä¸ç¼–å†™`class`çš„æƒ…å†µä¸‹ä½¿ç”¨`state`ä»¥åŠå…¶ä»–åˆ°çš„`React`ç‰¹æ€§
`Hook`çš„ç‰¹ç‚¹ï¼š
- ä½¿ä½ æ— éœ€ä¿®æ”¹ç»„ä»¶ç»“æ„çš„æƒ…å†µä¸‹å¤ç”¨çŠ¶æ€é€»è¾‘
- å¯å°†ç»„ä»¶ä¸­ç›¸äº’å…³è”çš„éƒ¨åˆ†æ‹†åˆ†æˆæ›´å°çš„å‡½æ•°ï¼Œå¤æ‚ç»„ä»¶å°†å˜å¾—æ›´å®¹æ˜“ç†è§£
- æ›´ç®€æ´ã€æ›´æ˜“ç†è§£çš„ä»£ç 

é™„ä¸Š[Reactå®˜æ–¹æ–‡æ¡£ - Hook](https://zh-hans.reactjs.org/docs/hooks-overview.html)

ä¸‹é¢ä¸»è¦è®°å½•ä¸‹ä¸€äº›hookçš„ä½¿ç”¨æ–¹æ³•
#### useState

## Redux æºç æ¢ç´¢
é˜…è¯»reduxæºç ï¼Œå¯ä»¥è®©æˆ‘ä»¬åœ¨å®è·µä¸­æ›´å¥½ä½¿ç”¨å®ƒï¼Œä¹Ÿå¯ä»¥å­¦ä¹ å®ƒæ¥åˆæ­¥è®¤JSè¯†å‡½æ•°å¼ç¼–ç¨‹

### æ–‡ä»¶ç»“æ„
```
|-- src
    |-- applyMiddleware.js  å°†middlewareä¸²è”èµ·æ¥ç”Ÿæˆä¸€ä¸ªæ›´å¼ºå¤§çš„dispatchå‡½æ•°ï¼Œå°±æ˜¯ä¸­é—´ä»¶çš„æœ¬è´¨ä½œç”¨
    |-- bindActionCreators.js  å°†action creatorsè½¬æ¢æˆæ‹¥æœ‰åŒåkeysçš„actionå¯¹è±¡
    |-- combineReducers.js  å°†å¤šä¸ªreducerç»„åˆèµ·æ¥ï¼Œæ¯ä¸€ä¸ªreducerç‹¬ç«‹ç®¡ç†è‡ªå·±å¯¹åº”çš„state
    |-- compose.js  å‡½æ•°å¼ç¼–ç¨‹ä¸­çš„ç»„åˆå‡½æ•°ï¼Œåœ¨applyMiddlewareä¸­è°ƒç”¨ï¼Œå°†middlewareä»å³å‘å·¦ä¾æ¬¡è°ƒç”¨ï¼Œç”Ÿæˆä¸€ä¸ªä»å·¦å‘å³æ‰§è¡Œmiddlewareçš„dispatchå¢å¼ºå‡½æ•°
    |-- createStore.js  æ ¸å¿ƒåŠŸèƒ½ï¼Œåˆ›å»ºä¸€ä¸ªstoreï¼Œå®ç°äº†4ä¸ªæ ¸å¿ƒå‡½æ•°ï¼Œdispatchã€subscribeã€getStateã€replaceReducer
    |-- index.js å¯¹å¤–æš´éœ²api
    |-- utils ä¾›å…¶ä»–çš„å‡½æ•°è°ƒç”¨çš„å·¥å…·å‡½æ•°æˆ–å˜é‡
        |-- actionTypes.js å†…ç½®action typeå˜é‡ï¼Œç”¨äºåˆå§‹åŒ–/é‡ç½® state
        |-- isPlainObject.js ç”¨äºæ ¡éªŒæ˜¯å¦æ˜¯çº¯å¯¹è±¡
        |-- warning.js é”™è¯¯æç¤ºå‡½æ•°
```
### å…¥å£æ–‡ä»¶
```javascript
import __DO_NOT_USE__ActionTypes from './utils/actionTypes'

// ä»…ç”¨äºåˆ¤æ–­ä»£ç æ˜¯å¦è¢«å‹ç¼©
function isCrushed() {}

// å¦‚æœéç”Ÿäº§ç¯å¢ƒå‹ç¼©äº†ä»£ç ä¼šæç¤ºç”¨æˆ·ï¼Œä½¿ç”¨å‹ç¼©åçš„reduxä»£ç ä¼šé™ä½æ€§èƒ½
if (
  process.env.NODE_ENV !== 'production' &&
  typeof isCrushed.name === 'string' &&
  isCrushed.name !== 'isCrushed'
) {
  warning('~~~')
}

export {
  createStore,
  combineReducers,
  bindActionCreators,
  applyMiddleware,
  compose,
  __DO_NOT_USE__ActionTypes
}

```
    æ³¨æ„ï¼šactionTypesè¢«æš´éœ²å‡ºå»ï¼Œä½†æ˜¯å¹¶ä¸å¸Œæœ›è¢«å¤–éƒ¨ä½¿ç”¨

### åˆ›å»ºä»“åº“ - `createStore()` 

`createStore` å‡½æ•°ï¼š
- è¾“å…¥ä¸‰ä¸ªå‚æ•°ï¼š`reducer` ï¼Œ`preloadedState` ï¼Œ `enhancer`
  - `reducer` éœ€è¦æ˜¯ä¸€ä¸ªçº¯å‡½æ•°ï¼Œç›¸åŒçš„è¾“å…¥ï¼Œä¸€å®šä¼šè¿”å›ç›¸åŒçš„è¾“å‡º
  - `preloadedState` åˆå§‹å€¼
  - `enhancer` ä¸­æ–‡æ„æ€ä¸º`å¢å¼ºå™¨`ï¼Œæ„æ€å°±æ˜¯è¿™é‡Œå¯ä»¥å¼•å…¥ç¬¬ä¸‰æ–¹åº“ï¼Œæ¥å¢å¼ºstoreåŠŸèƒ½ï¼Œreduxçš„å”¯ä¸€å¢å¼ºå™¨æ˜¯ `applyMiddleware()` ï¼Œç”¨äºå¼•å…¥ä¸­é—´ä»¶æ¥å¢å¼ºdispatchå‡½æ•°
- è¿”å›äº†4ä¸ªä¸»è¦å‡½æ•°ï¼š
  - `dispatch` : å‘èµ·`action`ï¼Œæ‰§è¡Œ`reducer`å‡½æ•°ï¼Œå¦‚æœæœ‰ä¸­é—´ä»¶ï¼Œdispatchå‘èµ·çš„`action`ä¼šç»è¿‡ä¸­é—´ä»¶çš„æ‰©å±•ï¼Œç„¶åå†æ‰§è¡Œ`reducer`å‡½æ•°
  - `subscribe` : ç”¨äºæ·»åŠ å¯¹stateçš„è®¢é˜…
  - `getState` : è·å–state
  - `replaceReducer` : åŠ¨æ€æ›¿æ¢reducer
- 5ä¸ªå†…éƒ¨å˜é‡ï¼š
  - `currentReducer` : ä¿å­˜å½“å‰çš„`reducer`
  - `currentState` : ä¿å­˜åº”ç”¨çš„å…¨å±€`store`çŠ¶æ€
  - `currentListeners` : ä¿å­˜å½“å‰çš„è®¢é˜…å‡½æ•°æ•°ç»„
  - `nextListeners` : è®¢é˜…å‡½æ•°æ•°ç»„çš„å¿«ç…§ï¼Œé¿å…ç›´æ¥ä¿®æ”¹`currentListeners`
  - `isDispatching` : ç”¨äºæ ‡è¯†æ˜¯å¦æ­£åœ¨è§¦å‘ä¸€ä¸ª`action`

ä¸‹é¢å†æ¥çœ‹ä¸€ä¸‹ `createStore` æºç å®ç°ï¼š
```javascript
// src/createStore.js
function createStore(reducer, preloadedState, enhancer) {
  // è¿™æ®µä»£ç ç”¨äºåˆ¤æ–­ä¼ é€’çš„å‚æ•°æ˜¯å¦ç¬¦åˆè§„èŒƒ
  if (
    (typeof preloadedState === 'function' && typeof enhancer === 'function') ||
    (typeof enhancer === 'function' && typeof arguments[3] === 'function')
  ) {
    throw new Error(
      'It looks like you are passing several store enhancers to ' +
        'createStore(). This is not supported. Instead, compose them ' +
        'together to a single function.'
    )
  }
  // åˆ¤æ–­ç¬¬äºŒä¸ªå‚æ•°ä¸ºfunctionæ—¶ï¼Œç¬¬ä¸‰ä¸ªå‚æ•°åˆä¸å­˜åœ¨æ—¶ï¼ŒæŠŠç¬¬äºŒä¸ªå‚æ•°ä½œä¸ºenhancer
  if (typeof preloadedState === 'function' && typeof enhancer === 'undefined') {
    enhancer = preloadedState
    preloadedState = undefined
  }

  // å¦‚æœ enhancer å‡½æ•°å­˜åœ¨ï¼Œæ‰§è¡Œ enhancer å‡½æ•°ï¼Œå¹¶ä¸”ä¸å†ç»§ç»­æ‰§è¡Œä¸‹å»
  if (typeof enhancer !== 'undefined') {
    if (typeof enhancer !== 'function') {
      throw new Error('Expected the enhancer to be a function.')
    }

    return enhancer(createStore)(reducer, preloadedState)
  }
  // reduceræ˜¯å¿…é€‰å‚æ•°ä¸”å¿…é¡»æ˜¯ä¸€ä¸ªå‡½æ•°
  if (typeof reducer !== 'function') {
    throw new Error('Expected the reducer to be a function.')
  }
  
  // å£°æ˜å†…éƒ¨ä½¿ç”¨å˜é‡
  // å­˜å‚¨å€¼
  let currentReducer = reducer
  // è®¾ç½®é»˜è®¤state
  let currentState = preloadedState
  // å­˜æ”¾å›è°ƒå‡½æ•°çš„è®¢é˜…æ•°ç»„
  let currentListeners = []
  // ä¸‹ä¸€æ¬¡çš„è®¢é˜…æ•°ç»„
  let nextListeners = currentListeners
  // ç”¨äºé˜²æ­¢åœ¨æ‰§è¡Œreducerå‡½æ•°æ—¶å†æ¬¡è§¦å‘dispatchå‡½æ•°
  let isDispatching = false

  /**
   * æµ…æ‹·è´ä¸€ä»½currentListeners ä¸ºä¸‹ä¸€é˜¶æ®µç›‘å¬å™¨æä¾›å¿«ç…§
   * ç”¨äºé˜²æ­¢åœ¨è§¦å‘è®¢é˜…/å–æ¶ˆè®¢é˜…å›è°ƒå‡½æ•°æ—¶å‡ºç°é”™è¯¯
   */
  function ensureCanMutateNextListeners() {
    if (nextListeners === currentListeners) {
      nextListeners = currentListeners.slice()
    }
  }

  /**
   * è·å–state
   * @returns {any} è¿”å›currentState
   */
  function getState() {
    // æ­£åœ¨æ‰§è¡Œdispatchå‡½æ•°æ—¶ä¸èƒ½è·å–ï¼Œå…¶å®ä¸€èˆ¬æƒ…å†µä¸‹ä¸ä¼šå‡ºç°è¿™ç§æƒ…å†µ
    if (isDispatching) {
      throw new Error(
        'You may not call store.getState() while the reducer is executing. ' +
          'The reducer has already received the state as an argument. ' +
          'Pass it down from the top reducer instead of reading it from the store.'
      )
    }

    return currentState
  }

  /**
   * ç”¨äºè®¢é˜…stateçš„æ›´æ–°
   *
   * @param {Function} listener è®¢é˜…å‡½æ•°
   * @returns {Function} è¿”å›å¯ä»¥ç§»é™¤listenerçš„å‡½æ•°
   */
  function subscribe(listener) {
    // ä¼ å…¥çš„listenerå¿…é¡»æ˜¯ä¸€ä¸ªå‡½æ•°
    if (typeof listener !== 'function') {
      throw new Error('Expected the listener to be a function.')
    }
    // ä¿è¯çº¯å‡½æ•°ä¸å¸¦æ¥å‰¯ä½œç”¨
    if (isDispatching) {
      throw new Error(
        'You may not call store.subscribe() while the reducer is executing. ' +
          'If you would like to be notified after the store has been updated, subscribe from a ' +
          'component and invoke store.getState() in the callback to access the latest state. ' +
          'See https://redux.js.org/api-reference/store#subscribe(listener) for more details.'
      )
    }

    let isSubscribed = true
    
    // åªæœ‰ç¬¬ä¸€æ¬¡æ‰§è¡Œæˆ–è€…æ¯æ¬¡dispatchä¹‹åçš„ç¬¬ä¸€æ¬¡subscribeæ—¶ä¼šæŠŠ currentListeners æ‹·è´å¹¶è¦†ç›– nextListeners ä¸­
    ensureCanMutateNextListeners()
    // nextListeners æ–°å¢listenerï¼ŒcurrentListenerså¹¶ä¸ä¼šæ–°å¢
    nextListeners.push(listener)
    
    // å–æ¶ˆè®¢é˜…
    return function unsubscribe() {
      if (!isSubscribed) {
        return
      }

      // ä¿è¯çº¯å‡½æ•°ä¸å¸¦æ¥å‰¯ä½œç”¨
      if (isDispatching) {
        throw new Error(
          'You may not unsubscribe from a store listener while the reducer is executing. ' +
            'See https://redux.js.org/api-reference/store#subscribe(listener) for more details.'
        )
      }

      isSubscribed = false
      // å–æ¶ˆè®¢é˜…å æŠŠ currentListeners æ‹·è´å¹¶è¦†ç›– nextListeners ä¸­
      ensureCanMutateNextListeners()
      const index = nextListeners.indexOf(listener)
      // ä»nextListenersä¸­åˆ é™¤unsubscribeçš„listener
      nextListeners.splice(index, 1)
      // æ¸…ç©ºå½“å‰çš„è®¢é˜…æ•°ç»„
      currentListeners = null
    }
  }

  /**
   * ç”¨äºæ‰§è¡Œreducerå‡½æ•°çš„å‡½æ•°
   */
  function dispatch(action) {
    // ä¿è¯actionæ˜¯ä¸ªçº¯å¯¹è±¡ï¼Œå³å­—é¢é‡å¯¹è±¡æˆ–Objectåˆ›å»ºçš„å¯¹è±¡
    if (!isPlainObject(action)) {
      throw new Error(
        'Actions must be plain objects. ' +
          'Use custom middleware for async actions.'
      )
    }
    // actionå¿…é¡»æœ‰typeå±æ€§å­˜åœ¨
    if (typeof action.type === 'undefined') {
      throw new Error(
        'Actions may not have an undefined "type" property. ' +
          'Have you misspelled a constant?'
      )
    }
    // æ­£åœ¨æ‰§è¡Œreducerå‡½æ•°æ—¶ä¸å…è®¸å†æ¬¡è§¦å‘
    if (isDispatching) {
      throw new Error('Reducers may not dispatch actions.')
    }

    try {
      isDispatching = true
      // æ‰§è¡Œreducer
      currentState = currentReducer(currentState, action)
    } finally {
      isDispatching = false
    }
    // é€šçŸ¥æ‰€æœ‰ä¹‹å‰é€šè¿‡subscribeè®¢é˜…stateæ›´æ–°çš„å›è°ƒlistener
    const listeners = (currentListeners = nextListeners)
    for (let i = 0; i < listeners.length; i++) {
      const listener = listeners[i]
      listener()
    }

    return action
  }

  /**
   * ç”¨äºæ›¿æ¢å½“å‰å­˜å‚¨çš„reducerå‡½æ•°
   * æ¯”å¦‚å½“ä½ éœ€è¦è¿›è¡Œä»£ç æ‹†åˆ†æˆ–è€…æƒ³è¦åŠ¨æ€åŠ è½½ä¸€äº›reducerã€æƒ³è¦ä¸ºreduxå®ç°çƒ­é‡è½½æ—¶
   *
   * @param {Function} nextReducer ç”¨äºæ›¿æ¢ store ä¸­çš„ reducer
   * @returns {void}
   */
  function replaceReducer(nextReducer) {
    if (typeof nextReducer !== 'function') {
      throw new Error('Expected the nextReducer to be a function.')
    }

    currentReducer = nextReducer

    // ActionTypes.REPLACEå…¶å®å°±æ˜¯ActionTypes.INIT
    // é‡æ–°INITä¾æ¬¡æ˜¯ä¸ºäº†è·å–æ–°çš„reducerä¸­çš„é»˜è®¤å‚æ•°
    dispatch({ type: ActionTypes.REPLACE })
  }

  // ç”¨äºè§‚å¯Ÿå’Œå“åº”çš„äº’é€š ç§æœ‰å±æ€§ï¼Œæš‚æ—¶å¹¶æœªä¸åšæ‰©å……
  function observable() {
    const outerSubscribe = subscribe
    return {
      /**
       * The minimal observable subscription method.
       * @param {Object} observer Any object that can be used as an observer.
       * The observer object should have a `next` method.
       * @returns {subscription} An object with an `unsubscribe` method that can
       * be used to unsubscribe the observable from the store, and prevent further
       * emission of values from the observable.
       */
      subscribe(observer) {
        if (typeof observer !== 'object' || observer === null) {
          throw new TypeError('Expected the observer to be an object.')
        }

        function observeState() {
          if (observer.next) {
            observer.next(getState())
          }
        }

        observeState()
        const unsubscribe = outerSubscribe(observeState)
        return { unsubscribe }
      },

      [$$observable]() {
        return this
      }
    }
  }

  // reducerè¦æ±‚å¯¹æ— æ³•è¯†åˆ«çš„actionè¿”å›stateï¼Œå°±æ˜¯å› ä¸ºéœ€è¦é€šè¿‡ActionTypes.INITè·å–é»˜è®¤å‚æ•°å€¼å¹¶è¿”å›
  // å½“initailStateå’Œreducerçš„å‚æ•°é»˜è®¤å€¼éƒ½å­˜åœ¨çš„æ—¶å€™ï¼Œreducerå‚æ•°é»˜è®¤å€¼å°†ä¸èµ·ä½œç”¨
  // å› ä¸ºåœ¨createStoreå£°æ˜å˜é‡æ—¶currStateå°±å·²ç»è¢«èµ‹å€¼äº†initialState
  // åŒæ—¶è¿™ä¸ªinitialStateä¹Ÿæ˜¯æœåŠ¡ç«¯æ¸²æŸ“çš„åˆå§‹çŠ¶æ€å…¥å£
  dispatch({ type: ActionTypes.INIT })

  return {
    dispatch,
    subscribe,
    getState,
    replaceReducer,
    [$$observable]: observable
  }
}

```
æ€»ç»“ä»¥ä¸‹å‡ ç‚¹æ³¨æ„äº‹é¡¹ï¼š
1. enhancer
```javascript
  // åˆ¤æ–­ç¬¬äºŒä¸ªå‚æ•°ä¸ºfunctionæ—¶ï¼Œç¬¬ä¸‰ä¸ªå‚æ•°åˆä¸å­˜åœ¨æ—¶ï¼ŒæŠŠç¬¬äºŒä¸ªå‚æ•°ä½œä¸ºenhancer
  if (typeof preloadedState === 'function' && typeof enhancer === 'undefined') {
    enhancer = preloadedState
    preloadedState = undefined
  }

  // å¦‚æœ enhancer å‡½æ•°å­˜åœ¨ï¼Œæ‰§è¡Œ enhancer å‡½æ•°ï¼Œå¹¶ä¸”ä¸å†ç»§ç»­æ‰§è¡Œä¸‹å»
  if (typeof enhancer !== 'undefined') {
    if (typeof enhancer !== 'function') {
      throw new Error('Expected the enhancer to be a function.')
    }

    return enhancer(createStore)(reducer, preloadedState)
  }
```
é¦–å…ˆ`enhancer`åœ¨ç¼ºçœæ¡ä»¶ä¸‹ï¼Œå¦‚æœ`preloadedState`æ˜¯ä¸ªå‡½æ•°ï¼Œåˆ™å°†å…¶è§†ä¸º`enhancer`ã€‚
`enhancer`æœ¬èº«æ˜¯ä¸ªå¼•å…¥ä¸­é—´ä»¶æ‰©å±•åŠŸèƒ½çš„è¿”å›å‡½æ•°ï¼Œ`enhancer(createStore)(reducer, preloadedState)`å®é™…ä¸Šæ˜¯è¾“å‡ºä¸€ä¸ªå¢å¼ºäº†`dispatch`åŠŸèƒ½çš„`store`
2. `nextListeners`åŠ`currentListeners`
    currentListeners ä¸ºå½“å‰çš„ listener, nextListeners ä¸ºä¸‹æ¬¡ dispatch åæ‰å‘å¸ƒçš„è®¢é˜…è€…é›†åˆ

å¯¹listeneråšæ·±æ‹·è´çš„åŸå› æ˜¯å› ä¸ºå¦‚æœåœ¨listenerä¸­è¿›è¡Œunsubscribeæ“ä½œï¼Œæ¯”å¦‚æœ‰3ä¸ªlistener(ä¸‹æ ‡0,1,2)ï¼Œåœ¨ç¬¬2ä¸ªlisteneræ‰§è¡Œæ—¶unsubscribeäº†è‡ªå·±ï¼Œé‚£ä¹ˆç¬¬3ä¸ªlistenerçš„ä¸‹æ ‡å°±å˜æˆäº†1ï¼Œä½†æ˜¯forå¾ªç¯ä¸‹ä¸€è½®çš„ä¸‹æ ‡æ˜¯2ï¼Œç¬¬3ä¸ªlistenerå°±è¢«è·³è¿‡äº†ï¼Œæ‰€ä»¥æ‰§è¡Œä¸€æ¬¡æ·±æ‹·è´ï¼Œå³ä½¿åœ¨listenerè¿‡ç¨‹ä¸­unsubscribeäº†ä¹Ÿæ˜¯æ›´æ”¹çš„nextListenersï¼ˆnextListenersä¼šå»æ·±æ‹·è´currentListenersï¼‰ã€‚å½“å‰æ‰§è¡Œçš„currentListenersä¸ä¼šè¢«ä¿®æ”¹ï¼Œç¬¬3ä¸ªlistenerå°±ä¸ä¼šè¢«è·³è¿‡äº†ã€‚

3. observable è¿™ä¸ªæ–¹æ³•æ˜¯ä¸ºRxjså‡†å¤‡çš„ï¼Œå¦‚æœä¸ä½¿ç”¨RxJSå¯ä»¥å¿½ç•¥ï¼Œåœ¨è¿™é‡Œç•¥è¿‡ã€‚
4. replaceReducer ç”¨äºåŠ¨æ€æ›¿æ¢æ•´ä¸ªstoreçš„reducer

### ç»„åˆreducer - `combineReducers()` 
ç”¨æ¥å°†è‹¥å¹²ä¸ªreduceråˆå¹¶æˆä¸€ä¸ªreducers
æºç å¤§éƒ¨åˆ†éƒ½æ˜¯ç”¨æ¥æ ¡éªŒæ•°æ®ã€æŠ›å‡ºé”™è¯¯
è¾…åŠ©æ–¹æ³•è¯´æ˜ï¼š
```javascript
// ç”¨äº
function getUndefinedStateErrorMessage(key, action) {
  const actionType = action && action.type
  const actionDescription =
    (actionType && `action "${String(actionType)}"`) || 'an action'
  // å³ä½¿æ²¡æœ‰å€¼åº”è¯¥è¿”å›nullï¼Œè€Œä¸è¦è¿”å›undefined
  return (
    `Given ${actionDescription}, reducer "${key}" returned undefined. ` +
    `To ignore an action, you must explicitly return the previous state. ` +
    `If you want this reducer to hold no value, you can return null instead of undefined.`
  )
}

function getUnexpectedStateShapeWarningMessage(
  inputState,
  reducers,
  action,
  unexpectedKeyCache
) {
  const reducerKeys = Object.keys(reducers)
  // åˆ¤æ–­actionTypeæ˜¯æ¥è‡ªreduxå†…éƒ¨init typeè¿˜æ˜¯å…¶ä»–çš„
  const argumentName =
    action && action.type === ActionTypes.INIT
      ? 'preloadedState argument passed to createStore'
      : 'previous state received by the reducer'

  // ç›‘æµ‹æ˜¯å¦æ²¡æœ‰ä¼ é€’reducer
  if (reducerKeys.length === 0) {
    return (
      'Store does not have a valid reducer. Make sure the argument passed ' +
      'to combineReducers is an object whose values are reducers.'
    )
  }
  // stateå¿…é¡»æ˜¯ä¸ªçº¯å¯¹è±¡
  if (!isPlainObject(inputState)) {
    return (
      `The ${argumentName} has unexpected type of "` +
      {}.toString.call(inputState).match(/\s([a-z|A-Z]+)/)[1] +
      `". Expected argument to be an object with the following ` +
      `keys: "${reducerKeys.join('", "')}"`
    )
  }
  // åˆ¤æ–­combineReduceråˆå¹¶çš„reducerä¸ªæ•°æ˜¯å¦å’ŒfinalReducersä¸ªæ•°æ˜¯å¦ç›¸åŒ
  // å¹¶è·å–ä¸ç›¸åŒçš„key
  const unexpectedKeys = Object.keys(inputState).filter(
    key => !reducers.hasOwnProperty(key) && !unexpectedKeyCache[key]
  )
  // æ ‡è®°ä¸ç›¸åŒçš„key
  unexpectedKeys.forEach(key => {
    unexpectedKeyCache[key] = true
  })
  // å½“æ˜¯è°ƒç”¨replaceReducersæ—¶ï¼Œå°±ä¸éœ€è¦å†åˆ¤æ–­ï¼Œç›´æ¥è¿”å›
  if (action && action.type === ActionTypes.REPLACE) return
  // å‘Šè¯‰ä½ æœ‰ä»€ä¹ˆå€¼æ˜¯å¤šå‡ºæ¥çš„ï¼Œä¼šè¢«å¿½ç•¥æ‰
  if (unexpectedKeys.length > 0) {
    return (
      `Unexpected ${unexpectedKeys.length > 1 ? 'keys' : 'key'} ` +
      `"${unexpectedKeys.join('", "')}" found in ${argumentName}. ` +
      `Expected to find one of the known reducer keys instead: ` +
      `"${reducerKeys.join('", "')}". Unexpected keys will be ignored.`
    )
  }
}
// ç”¨æ¥åˆ¤æ–­åˆå§‹åŒ–å’ŒéšæœºçŠ¶æ€ä¸‹è¿”å›çš„æ˜¯ä¸æ˜¯ undefined
function assertReducerShape(reducers) {
  Object.keys(reducers).forEach(key => {
    // éå† reducer
    const reducer = reducers[key]
    // åˆå§‹åŒ– reducerï¼Œå¾—åˆ°ä¸€ä¸ªstateå€¼
    const initialState = reducer(undefined, { type: ActionTypes.INIT })
    // åˆå§‹åŒ–çŠ¶æ€ä¸‹ state ä¸èƒ½è¿”å›undefined
    if (typeof initialState === 'undefined') {
      throw new Error(
        `Reducer "${key}" returned undefined during initialization. ` +
          `If the state passed to the reducer is undefined, you must ` +
          `explicitly return the initial state. The initial state may ` +
          `not be undefined. If you don't want to set a value for this reducer, ` +
          `you can use null instead of undefined.`
      )
    }
    // éšæœºçŠ¶æ€ä¸‹ state ä¹Ÿèƒ½è¿”å›undefined
    if (
      typeof reducer(undefined, {
        type: ActionTypes.PROBE_UNKNOWN_ACTION()
      }) === 'undefined'
    ) {
      throw new Error(
        `Reducer "${key}" returned undefined when probed with a random type. ` +
          `Don't try to handle ${ActionTypes.INIT} or other actions in "redux/*" ` +
          `namespace. They are considered private. Instead, you must return the ` +
          `current state for any unknown actions, unless it is undefined, ` +
          `in which case you must return the initial state, regardless of the ` +
          `action type. The initial state may not be undefined, but can be null.`
      )
    }
  })
}

```
ä¸»è¦å‡½æ•°è¯´æ˜ï¼š
```javascript
export default function combineReducers(reducers) {
  // è·å–ä¼ å…¥reducersçš„æ‰€æœ‰key
  const reducerKeys = Object.keys(reducers)
  // æœ€åçœŸæ­£æœ‰æ•ˆçš„reducerå­˜åœ¨è¿™é‡Œ
  const finalReducers = {}
  // ç­›é€‰å‡ºæœ‰æ•ˆçš„reducer
  for (let i = 0; i < reducerKeys.length; i++) {
    const key = reducerKeys[i]

    if (process.env.NODE_ENV !== 'production') {
      if (typeof reducers[key] === 'undefined') {
        warning(`No reducer provided for key "${key}"`)
      }
    }
    // reducerå¿…é¡»æ˜¯å‡½æ•°ï¼Œæ— æ•ˆçš„æ•°æ®ä¸ä¼šè¢«åˆå¹¶è¿›æ¥
    if (typeof reducers[key] === 'function') {
      finalReducers[key] = reducers[key]
    }
  }
  // æ‰€æœ‰å¯ç”¨reducer
  const finalReducerKeys = Object.keys(finalReducers)

  // This is used to make sure we don't warn about the same
  // keys multiple times.
  // ç”¨äºé…åˆgetUnexpectedStateShapeWarningMessageè¾…åŠ©å‡½æ•°è¿‡æ»¤æ‰å¤šå‡ºæ¥çš„å€¼
  let unexpectedKeyCache
  if (process.env.NODE_ENV !== 'production') {
    unexpectedKeyCache = {}
  }

  let shapeAssertionError
  try {
    // æ ¡éªŒreducersæ˜¯å¦éƒ½æ˜¯æœ‰æ•ˆæ•°æ®
    assertReducerShape(finalReducers)
  } catch (e) {
    shapeAssertionError = e
  }

  // è¿”å›ä¸€ä¸ªåˆå¹¶åçš„ reducer å‡½æ•°ï¼Œä¸æ™®é€šçš„ reducer ä¸€æ ·
  // ä¸»è¦é€»è¾‘ï¼šå–å¾—æ¯ä¸ªå­reducerå¯¹åº”çš„stateï¼Œä¸actionä¸€èµ·ä½œä¸ºå‚æ•°ç»™æ¯ä¸ªå­reduceræ‰§è¡Œã€‚
  return function combination(state = {}, action) {
    if (shapeAssertionError) {
      throw shapeAssertionError
    }

    if (process.env.NODE_ENV !== 'production') {
      // å¼€å‘ç¯å¢ƒä¸‹æ ¡éªŒæœ‰å“ªäº›å€¼æ˜¯å¤šå‡ºæ¥çš„
      const warningMessage = getUnexpectedStateShapeWarningMessage(
        state,
        finalReducers,
        action,
        unexpectedKeyCache
      )
      if (warningMessage) {
        warning(warningMessage)
      }
    }

    let hasChanged = false // æ ‡å¿—stateæ˜¯å¦æœ‰å˜åŒ–
    const nextState = {}
    // ä¸‹é¢å°±ä¼šè¿›è¡Œè·å–reducerå¯¹åº”çš„stateï¼Œä¸actionä¸€èµ·ä½œä¸ºå‚æ•°ç»™æ¯ä¸ªå­reduceræ‰§è¡Œã€‚
    for (let i = 0; i < finalReducerKeys.length; i++) {
      // è·å–æœ¬æ¬¡å¾ªç¯çš„å­reducer
      const key = finalReducerKeys[i]
      const reducer = finalReducers[key]
      // è·å–è¯¥å­reducerå¯¹åº”çš„æ—§çš„state
      const previousStateForKey = state[key]
      // è¯¥å­reduceræ‰§è¡Œåè¿”å›çš„æ–°çš„state
      const nextStateForKey = reducer(previousStateForKey, action)
      // å¦‚æœæ–°çš„stateæ˜¯undefinedå°±æŠ›å‡ºå¯¹åº”é”™è¯¯
      if (typeof nextStateForKey === 'undefined') {
        const errorMessage = getUndefinedStateErrorMessage(key, action)
        throw new Error(errorMessage)
      }
      // ç”¨æ–°çš„stateæ›¿æ¢æ—§çš„state
      nextState[key] = nextStateForKey
      // åˆ¤æ–­stateæ˜¯å¦æ”¹å˜
      hasChanged = hasChanged || nextStateForKey !== previousStateForKey
    }
    // æ”¹å˜åè¿”å›æ–°çš„stateï¼Œæœªæ”¹å˜è¿”å›æ—§çš„å€¼
    return hasChanged ? nextState : state
  }
}

```

### æ·»åŠ ä¸­é—´ä»¶ - `applyMiddleware()`
applyMiddlewareï¼Œé¡¾åæ€ä¹‰ï¼Œå°±æ˜¯è¿ç”¨ä¸­é—´ä»¶ã€‚
ä½œç”¨ï¼šæŠŠä¸€ç³»åˆ—ä¸­é—´ä»¶è½¬æ¢ä¸ºå¢å¼º`dispatch`çš„å‡½æ•°`enhancer`
æºç åªæœ‰20è¡Œï¼Œä¸»è¦å†…å®¹åªæœ‰åå‡ è¡Œï¼Œå¦‚ä¸‹ï¼š
```javascript
function applyMiddleware(...middlewares) {
  // middlewares ä¸ºä¼ å…¥çš„ä¸€ç³»åˆ—ä¸­é—´ä»¶ï¼Œç­‰å¾…è°ƒç”¨
  // è¿™é‡Œè¿”å›çš„å°±æ˜¯enhancerï¼Œenhancerä¼šæ¥æ”¶createStoreå¹¶è¿”å›ä¸€ä¸ªå‡½æ•°
  // åœ¨createStoreä¸­ï¼Œå½“å­˜åœ¨enhanceræ—¶ï¼Œæ‹¦æˆªäº†createStoreä¸‹é¢éœ€è¦æ‰§è¡Œçš„ä»£ç ï¼Œ
  // è¿”å›æ‰§è¡Œenhancer(createStore)(reducer, preloadedState)çš„ç»“æœ
  return createStore => (...args) => {
    // æ‰§è¡Œenhancer(createStore)(reducer, preloadedState)æ˜¯ä¼šè°ƒç”¨ä¸‹é¢ä»£ç 
    // ç»§ç»­æ‰§è¡ŒcreateStoreï¼Œè¿”å›store
    const store = createStore(...args)
    let dispatch = () => {
      throw new Error(
        'Dispatching while constructing your middleware is not allowed. ' +
          'Other middleware would not be applied to this dispatch.'
      )
    }
    // ä¼ é€’ç»™ä¸­é—´ä»¶ä½¿ç”¨çš„api
    const middlewareAPI = {
      getState: store.getState,
      dispatch: (...args) => dispatch(...args)
    }
    // éå†å¹¶æ‰§è¡Œä¸­é—´ä»¶å‡½æ•°ï¼ŒæŠŠæ‰§è¡Œç»“æœå­˜æ”¾äºchain
    // æ¯ä¸€ä¸ªä¸­é—´ä»¶å‡½æ•°çš„è¿”å›å€¼æ˜¯ä¸€ä¸ªæ”¹é€ çš„dispatchå‡½æ•°
    const chain = middlewares.map(middleware => middleware(middlewareAPI))
    // ç”¨composeå»æ”¹é€ dispatchå‡½æ•°ï¼Œå¾—åˆ°ä¸€ä¸ªå¢å¼ºçš„dispatchå‡½æ•°
    dispatch = compose(...chain)(store.dispatch)
    // compose(func1,func2,func3)
    // è¿”å›ä¸€ä¸ªå‡½æ•°: (...args) => func1( func2( func3(...args) ) )
    // ä¼ å…¥çš„dispatchè¢«func3æ”¹é€ åå¾—åˆ°ä¸€ä¸ªæ–°çš„dispatchï¼Œæ–°çš„dispatchç»§ç»­è¢«func2æ”¹é€ .
    // å› æ­¤æ¯ä¸ªä¸­é—´ä»¶å†…éƒ¨å¿…é¡»æ‰§è¡Œdispatchæ‰ä¼šç»§ç»­ä¸‹ä¸€ä¸ªä¸­é—´ä»¶çš„è°ƒç”¨

    // ç»§ç»­è¿”å›storeï¼Œå¹¶ç”¨åŠ å¼ºç‰ˆçš„dispatchè¦†ç›–æ—§çš„dispatch
    return {
      ...store,
      dispatch
    }
  }
}

```
ç¼–å†™ä¸€ä¸ªæœ€ç®€å•çš„ç¬¦åˆè§„èŒƒçš„ä¸­é—´ä»¶ï¼š
```javascript
function logger({ dispatch, getState }) {
  // middlewareAPI  ä¸­åŒ…å«äº†dispatch, getStateè¿™ä¸¤ä¸ªæ–¹æ³•
  // ä½†æ˜¯è°ƒç”¨middlewareAPIçš„dispatchå‡½æ•°ä¼šæŠ›å‡ºå¼‚å¸¸ï¼Œå¯ä»¥æŸ¥çœ‹ä¸Šé¢æºç 
  // è¿”å›çœŸæ­£çš„ä¸­é—´ä»¶æ‰§è¡Œå‡½æ•° ä¸‹é¢çš„nextå°±æ˜¯å¢å¼ºçš„dispatch
  return next => {
    return action => {
      console.log('logger')
      // æ‰§è¡Œæ”¹ä¸­é—´ä»¶ä»»åŠ¡
      console.log(action.type + 'æ‰§è¡Œäº†ï¼ï¼ï¼')
      // æ‰§è¡Œä¸‹ä¸€ä¸ªä¸­é—´ä»¶
      next(action)
    }
  }
}
// å®ç°å¼‚æ­¥çš„ä¸­é—´ä»¶ - thunk redux-thunkä¹Ÿæ˜¯è¿™æ ·å®ç°çš„ï¼Œä¸è¿‡åŠ äº†å±‚å‡½æ•°åŒ…è£¹ï¼Œå®ç°ä¼ é€’å‚é¢å¤–å‚æ•°
const thunk = ({dispatch, getState}) => next => action => {
    if (typeof action == 'function') {
        return action(dispatch, getState)
    }
    return next(action)
}
```

### ç»‘å®šactionCreator - `bindActionCreators`
ä½œç”¨ï¼š å®é™…ä¸Šå°±æ˜¯é€šè¿‡è¿”å›ä¸€ä¸ªé«˜é˜¶å‡½æ•°ï¼Œé€šè¿‡é—­åŒ…åº”ç”¨ï¼Œå°†dispatchéšè—èµ·æ¥ï¼Œæ­£å¸¸å‘èµ·ä¸€ä¸ªdispatch(action)ï¼Œä½†æ˜¯bindActionCreatorså°†dispatchéšè—ï¼Œå½“æ‰§è¡ŒbindActionCreatorsæ—¶ï¼š
- å¦‚æœä¼ å…¥çš„æ˜¯ä¸€ä¸ªå‡½æ•°ï¼Œå°±è®¤ä¸ºä¼ å…¥äº†ä¸€ä¸ªactionCreatorï¼Œè½¬æ¢æˆè¿™æ ·ï¼š() => dispatch(actionCreators(...arguments))
- å¦‚æœä¼ å…¥çš„æ˜¯å¯¹è±¡ï¼ŒåŒ…å«å¤šä¸ªactionCreatorï¼Œå°±ä¼šéå†è¿”å›ä¸€ä¸ªå¯¹è±¡çš„å¯¹è±¡ï¼Œå¯¹æ¯ä¸ªkeyå€¼éƒ½è¿›è¡Œä¸Šé¢çš„è½¬æ¢

```javascript
// è¿”å›ä¸€ä¸ªé«˜é˜¶å‡½æ•°
function bindActionCreator(actionCreator, dispatch) {
  return function() {
    // æ‰§è¡ŒactionCreatorï¼Œè·å–actionï¼Œå†ç”¨dispatchè¿›è¡Œæ´¾å‘action
    return dispatch(actionCreator.apply(this, arguments))
  }
}

export default function bindActionCreators(actionCreators, dispatch) {
  // actionCreatorså¦‚æœæ˜¯å‡½æ•°ï¼Œå°±è®¤ä¸ºå°±æ˜¯ä¸€ä¸ªactionCreatorå‡½æ•°ï¼Œ
  // ç›´æ¥è°ƒç”¨bindActionCreatorè½¬æ¢ç”Ÿæˆä¸€ä¸ªå¯ä»¥ç”¨dispatchæ´¾å‘çš„action
  if (typeof actionCreators === 'function') {
    return bindActionCreator(actionCreators, dispatch)
  }
  // ä¼ å…¥çš„åªèƒ½æ˜¯å¯¹è±¡æˆ–è€…å‡½æ•°ï¼Œå‡½æ•°åœ¨ä¸Šé¢å·²ç»è¿›è¡Œæ“ä½œäº†
  if (typeof actionCreators !== 'object' || actionCreators === null) {
    throw new Error(
      `bindActionCreators expected an object or a function, instead received ${
        actionCreators === null ? 'null' : typeof actionCreators
      }. ` +
        `Did you write "import ActionCreators from" instead of "import * as ActionCreators from"?`
    )
  }
  // è¿™é‡Œå¤„ç†actionCreatorsæ˜¯ä¸€ç»„åŒ…å«actionCreatorçš„å¯¹è±¡æ—¶
  const boundActionCreators = {}
  for (const key in actionCreators) {
    const actionCreator = actionCreators[key]
    if (typeof actionCreator === 'function') {
      // æ¯ä¸€ä¸ªkeyå†æ¬¡è°ƒç”¨bindActionCreatorè¿›è¡Œè½¬æ¢
      boundActionCreators[key] = bindActionCreator(actionCreator, dispatch)
    }
  }
  // è¿”å›å¤„ç†åçš„å¯¹è±¡
  return boundActionCreators
}
```

### ç»„åˆå‡½æ•° - compose
å‡½æ•°å¼ç¼–ç¨‹ä¸­å¸¸ç”¨çš„æ–¹æ³•ã€‚
```javascript
function compose(...funcs) {
  // æ²¡æœ‰å‚æ•°çš„è¯ç›´æ¥è¿”å›ä¸€ä¸ªå‡½æ•°ç»„ä»¶
  // compose()(a) -> a
  // å…ˆè¿”å›ä¸€ä¸ªè¿”å›è‡ªèº«å‚æ•°çš„å‡½æ•° -> å‡½æ•°æ‰§è¡Œ,è¿”å›a
  if (funcs.length === 0) {
    return arg => arg
  }

  // åªæœ‰ä¸€ä¸ªå‡½æ•°å‚æ•°æ—¶è¿”å›è¯¥å‡½æ•°å‚æ•°
  // compose(withA)(a) -> withA(a)
  // å…ˆè¿”å›ä¸€ä¸ªwithAå‡½æ•° -> å‡½æ•°æ‰§è¡Œ,å¹¶ä¸”å‚æ•°ä¸ºa
  if (funcs.length === 1) {
    return funcs[0]
  }

  // ç”¨reduceéå†funcsï¼Œå¹¶ä¸”å½¢æˆæœ€ç»ˆéœ€è¦æ‰§è¡Œçš„å‡½æ•°
  // compose(withA, withB, withC, withD)(a) 
  // -> withA(withB(withC(withD(a))))
  return funcs.reduce((a, b) => {
    return (...args) => a(b(...args))
  })
  // å½“aï¼Œbå‚æ•°ä¸ºwithAï¼ŒwithBæ—¶ï¼Œ return (...args) -> withA(withB(...args))
  // å½“aï¼Œbå‚æ•°ä¸ºä¸Šä¸€è½®è¿”å›å‡½æ•°ï¼ŒwithCæ—¶ï¼Œ 
  // return (...args2) -> (...args) => withA(withB(...args))(withC(...args2)) 
  // æ‰§è¡Œç»“æœä¸ºï¼š 
  // (...args2) => withA(withB(withC))(withC(...args2))
  // ... æŒç»­æ‰§è¡Œ,æœ€ç»ˆç»“æœè¿”å›ä¸€ä¸ªå‡½æ•°ï¼Œå‡½æ•°çš„å‚æ•°æ”¾åœ¨funcsæœ€åä¸€ä¸ªå‡½æ•°ï¼š
  // (...argsN) => withA(withB(withC(...withN(...argsN))))
}
```

### å‚è€ƒé“¾æ¥
[redux githubä»“åº“](https://github.com/reduxjs/redux)

[é€šè¿‡Github Blameæ·±å…¥åˆ†æReduxæºç ](https://github.com/fi3ework/blog/issues/7)

[ä¸€æ¬¡æ€§å½»åº•å¸æ”¶ Redux æºç ](https://juejin.im/post/5d308b2c6fb9a07ec63b4cad#heading-0)

[æ›´å¥½ç”¨çš„ Redux](https://juejin.im/post/5bc318b25188255c5f5414e7)

[JSå‡½æ•°å¼ç¼–ç¨‹æŒ‡å—](https://llh911001.gitbooks.io/mostly-adequate-guide-chinese/content/)

## React å’Œ redux å¸¸è§é¢è¯•é¢˜ 

### Reactä¸­ setState æ˜¯åŒæ­¥çš„è¿˜æ˜¯å¼‚æ­¥çš„ï¼Ÿ

[æ·±å…¥ setState æœºåˆ¶](https://github.com/sisterAn/blog/issues/26)
[React å®˜æ–¹æè¿°](https://reactjs.org/docs/faq-state.html#when-is-setstate-asynchronous)
